name: Monorepo CI/CD - Deploy Changed Services to EKS

# 1. 트리거
on:
  pull_request:
    types: [ closed ]       # PR이 '닫혔을 때'
    branches: [ "main" ]    # 'main' 브랜치를 대상으로 하는 PR일 때

# 2. 환경 변수
env:
  AWS_REGION: "ap-northeast-2"
  EKS_CLUSTER_NAME: "orbit"
  ECR_REGISTRY_URL: "897722707137.dkr.ecr.ap-northeast-2.amazonaws.com"
  K8S_NAMESPACE: "orbit"

# 3. 권한 설정
permissions:
  id-token: write
  contents: read

jobs:
  # -------------------------------------------------------------
  # 잡 1: 변경된 모듈(서비스) 감지
  # -------------------------------------------------------------
  detect-changes:
    # (중요) PR이 '머지(merged)'된 경우에만 실행
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # PR 비교를 위해 필요

      - name: Detect changed services (using paths-filter)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api-gateway:
              - 'api-gateway/**'
            chat:
              - 'chat/**'
            chat-db: 
              - 'chat-db/**'
            drive:
              - 'drive/**'
            search:
              - 'search/**'
            user:
              - 'user/**'
            workspace:
              - 'workspace/**'

      - name: "Debug: Print filter output"
        run: |
          echo "Filter output (changes): ${{ steps.filter.outputs.changes }}"
          echo "Filter output (json): ${{ toJson(steps.filter.outputs) }}"

  # -------------------------------------------------------------
  # 잡 2: 변경된 모듈만 병렬로 빌드 및 배포
  # -------------------------------------------------------------
  build-and-deploy:
    needs: detect-changes
    # detect-changes 잡의 if 조건이 false면 스킵되므로,
    # outputs.services가 비어있게 되어 이 잡도 자동으로 스킵됩니다.
    if: "needs.detect-changes.outputs.services != '[]' && needs.detect-changes.outputs.services != ''"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr

      - name: Map Folder to ECR and K8s Names
        id: map-names
        run: |
          SERVICE_FOLDER=${{ matrix.service }}
          ECR_REPO_NAME="" 
          K8S_DEPLOYMENT_NAME="" 

          if [ "$SERVICE_FOLDER" == "api-gateway" ]; then
            ECR_REPO_NAME="orbit/apigateway"
            K8S_DEPLOYMENT_NAME="api-gateway-depl"
          elif [ "$SERVICE_FOLDER" == "chat" ]; then
            ECR_REPO_NAME="orbit/chat"
            K8S_DEPLOYMENT_NAME="chat-service-depl"
          elif [ "$SERVICE_FOLDER" == "chat-db" ]; then
            ECR_REPO_NAME="orbit/chat-db"
            K8S_DEPLOYMENT_NAME="chat-db-service-depl"
          elif [ "$SERVICE_FOLDER" == "drive" ]; then
            ECR_REPO_NAME="orbit/drive"
            K8S_DEPLOYMENT_NAME="drive-service-depl"
          elif [ "$SERVICE_FOLDER" == "search" ]; then
            ECR_REPO_NAME="orbit/search"
            K8S_DEPLOYMENT_NAME="search-service-depl"
          elif [ "$SERVICE_FOLDER" == "user" ]; then
            ECR_REPO_NAME="orbit/user"
            K8S_DEPLOYMENT_NAME="user-service-deployment"
          elif [ "$SERVICE_FOLDER" == "workspace" ]; then
            ECR_REPO_NAME="orbit/workspace"
            K8S_DEPLOYMENT_NAME="workspace-service-depl"
          else
            echo "::error:: Unknown service folder $SERVICE_FOLDER."
            exit 1
          fi
          
          echo "ecr_repo=$ECR_REPO_NAME" >> $GITHUB_OUTPUT
          echo "k8s_deployment=$K8S_DEPLOYMENT_NAME" >> $GITHUB_OUTPUT

      - name: Build, tag, and push Docker image to ECR
        id: build-image
        env:
          # (중요) PR 머지 시에는 github.sha가 머지 커밋의 SHA를 올바르게 가리킵니다.
          IMAGE_TAG: ${{ github.sha }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          SERVICE_FOLDER: ${{ matrix.service }}
          ECR_REPO_NAME: ${{ steps.map-names.outputs.ecr_repo }}
        run: |
          echo "Building service from folder: $SERVICE_FOLDER"
          cd $SERVICE_FOLDER
          docker build -t $ECR_REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG --build-arg GITHUB_USER=EunDuk2 --build-arg GITHUB_TOKEN=${{ secrets.GH_TOKEN }} .
          docker build -t $ECR_REGISTRY/$ECR_REPO_NAME:latest --build-arg GITHUB_USER=EunDuk2 --build-arg GITHUB_TOKEN=${{ secrets.GH_TOKEN }} .
          docker push $ECR_REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPO_NAME:latest

      - name: Update Kubeconfig
        uses: aws-actions/amazon-eks-get-kubeconfig@v1
        with:
          name: ${{ env.EKS_CLUSTER_NAME }}
          region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}

      - name: Deploy to EKS (Set Image)
        env:
          K8S_DEPLOYMENT_NAME: ${{ steps.map-names.outputs.k8s_deployment }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPO_NAME: ${{ steps.map-names.outputs.ecr_repo }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Deploying ${{ matrix.service }} (K8s: $K8S_DEPLOYMENT_NAME)..."
          kubectl set image deployment/$K8S_DEPLOYMENT_NAME *=*$ECR_REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG -n ${{ env.K8S_NAMESPACE }}