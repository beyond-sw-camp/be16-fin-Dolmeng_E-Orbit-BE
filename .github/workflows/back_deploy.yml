# -------------------------------------------------------------
  # 잡 2: (수정됨) Access Key 방식으로 빌드 및 배포
  # -------------------------------------------------------------
  build-and-deploy:
    needs: detect-changes
    if: "needs.detect-changes.outputs.services != '[]' && needs.detect-changes.outputs.services != ''"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # [수정됨] OIDC 대신 IAM User Access Key로 인증
      - name: Configure AWS Credentials (Access Key)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr

      - name: Map Folder to ECR and K8s Names
        id: map-names
        run: |
          SERVICE_FOLDER=${{ matrix.service }}
          ECR_REPO_NAME="" 
          K8S_DEPLOYMENT_NAME="" 

          if [ "$SERVICE_FOLDER" == "api-gateway" ]; then
            ECR_REPO_NAME="orbit/apigateway"
            K8S_DEPLOYMENT_NAME="api-gateway-depl"
          elif [ "$SERVICE_FOLDER" == "chat" ]; then
            ECR_REPO_NAME="orbit/chat"
            K8S_DEPLOYMENT_NAME="chat-depl"
          elif [ "$SERVICE_FOLDER" == "chat-db" ]; then
            ECR_REPO_NAME="orbit/chat-db"
            K8S_DEPLOYMENT_NAME="chat-db-depl"
          elif [ "$SERVICE_FOLDER" == "drive" ]; then
            ECR_REPO_NAME="orbit/drive"
            K8S_DEPLOYMENT_NAME="drive-depl"
          elif [ "$SERVICE_FOLDER" == "search" ]; then
            ECR_REPO_NAME="orbit/search"
            K8S_DEPLOYMENT_NAME="search-depl"
          elif [ "$SERVICE_FOLDER" == "user" ]; then
            ECR_REPO_NAME="orbit/user"
            K8S_DEPLOYMENT_NAME="user-depl"
          elif [ "$SERVICE_FOLDER" == "workspace" ]; then
            ECR_REPO_NAME="orbit/workspace"
            K8S_DEPLOYMENT_NAME="workspace-depl"
          else
            echo "::error:: Unknown service folder $SERVICE_FOLDER."
            exit 1
          fi
          
          echo "ecr_repo=$ECR_REPO_NAME" >> $GITHUB_OUTPUT
          echo "k8s_deployment=$K8S_DEPLOYMENT_NAME" >> $GITHUB_OUTPUT

      - name: Build, tag, and push Docker image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          SERVICE_FOLDER: ${{ matrix.service }}
          ECR_REPO_NAME: ${{ steps.map-names.outputs.ecr_repo }}
        run: |
          echo "Building service from folder: $SERVICE_FOLDER"
          cd $SERVICE_FOLDER
          docker build -t $ECR_REGISTRY/$ECR_REPO_NAME:latest --build-arg GITHUB_USER=EunDuk2 --build-arg GITHUB_TOKEN=${{ secrets.GH_TOKEN }} .
          docker push $ECR_REGISTRY/$ECR_REPO_NAME:latest

      # [수정됨] 1. 'get-' 오타 수정 / 2. 'role-to-assume' 삭제
      - name: Update Kubeconfig
        uses: aws-actions/amazon-eks-get-kubeconfig@v1
        with:
          cluster-name: ${{ env.EKS_CLUSTER_NAME }}
          region: ${{ env.AWS_REGION }}
          # role-to-assume은 Access Key 방식에선 필요 없으므로 삭제합니다.

      - name: Deploy to EKS (Set Image)
        env:
          K8S_DEPLOYMENT_NAME: ${{ steps.map-names.outputs.k8s_deployment }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPO_NAME: ${{ steps.map-names.outputs.ecr_repo }}
        run: |
          echo "Deploying ${{ matrix.service }} (K8s: $K8S_DEPLOYMENT_NAME)..."
          kubectl set image deployment/$K8S_DEPLOYMENT_NAME *=$ECR_REGISTRY/$ECR_REPO_NAME:latest -n ${{ env.K8S_NAMESPACE }}