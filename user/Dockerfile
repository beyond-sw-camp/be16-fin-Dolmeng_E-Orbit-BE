##############################################
# ğŸ—ï¸ 1ï¸âƒ£ Build Stage
##############################################
FROM eclipse-temurin:17-jdk-jammy AS build

WORKDIR /app

# GitHub Packages ì¸ì¦ìš© ARG (ë¹Œë“œ ì‹œ --build-arg ë¡œ ì „ë‹¬ë¨)
ARG GITHUB_USER
ARG GITHUB_TOKEN

# í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬ (Gradleì´ System.getenv()ë¡œ ì°¸ì¡° ê°€ëŠ¥)
ENV GITHUB_USER=${GITHUB_USER}
ENV GITHUB_TOKEN=${GITHUB_TOKEN}

# Gradle wrapper ë° ì†ŒìŠ¤ ë³µì‚¬
COPY gradle gradle
COPY src src
COPY build.gradle .
COPY settings.gradle .
COPY gradlew .

# Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
RUN chmod +x gradlew

# Gradle ìºì‹œ ë””ë ‰í† ë¦¬ ì§€ì • (ì†ë„ ê°œì„ )
ENV GRADLE_USER_HOME=/cache

# Gradle ë¹Œë“œ ìˆ˜í–‰ (GitHub Packages ì ‘ê·¼ í¬í•¨)
RUN ./gradlew clean bootJar --no-daemon

##############################################
# ğŸš€ 2ï¸âƒ£ Runtime Stage
##############################################
FROM eclipse-temurin:17-jre-jammy AS runtime

WORKDIR /app

# Stage1ì—ì„œ ë¹Œë“œëœ JAR ë³µì‚¬
COPY --from=build /app/build/libs/*.jar app.jar

# ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ ì‹¤í–‰í•  ëª…ë ¹
ENTRYPOINT ["java", "-Dspring.profiles.active=prod", "-jar", "app.jar"]
